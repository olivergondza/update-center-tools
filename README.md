# update-center-tools

This tooling helps with managing a set of separated Jenkins update centers based
on plain `.hpi` directories. User with access can manipulate all these update
centers (AKA plugin collections) and turn them into http exposed update center
once ready.

Note that unlike community update center, this tooling expects only one version
of every plugin will be present in the updatecenter.

## Setup

The tooling expects this repository to be checked out on both client and server (update center).

### Server

Path | |
--- | ---
`/opt/update-center-tools/` | Checked-out update-center-tools.
`/opt/update-center/` | Checked-out [backend-update-center2](https://github.com/ikedam/backend-update-center2).
`/var/opt/update-center/<id>/` | Plugins for update center. These are manipulated by the tolling.
`/var/www/<id>/` | Update center directories exposed through http server. Generated by the tooling.

### Client

Aside from getting the sources it is necessary to configure the address of the
update center in `hostname` in tooling root directory. Most of the commands that
manipulate the update center uses ssl/scp so you might be interested in providing
different username as well. If Omitted, current username will be used.

    echo 'updater@updatenter.example.com' > hostname

## Consuming content

Exposed content can be consumed in several ways:

### Connecting to Jenkins

Tooling generated necessary metadata so update center can be consumed from
Jenkins the same way as upstream update center. [How to set that up?](https://github.com/ikedam/backend-update-center2/wiki/How-to-create-your-own-Jenkins-Update-Center)?

### Downloading manually

Aside from the hierarchy exposed by standard Jenkins update center. This tooling
exposes tar.gz archive of all the plugins from certain collection for easier downloading.
There is also a special command to download whole plugin collection into one directory.

## Manipulating content

All the command in the tooling fits into 2 categories: client and server commands.
Commands its name starts with `client` are meant to be called remotely, while those
that does not are supposed to be called on update center host itself. There is a
way to call server command from client:

    # on server
    $ ./my-command.sh and my arguments
    # can be called from client like so
    $ ./client.sh my-command.sh and my arguments

To make sure this work it is expected to have the same version checked out on both ends.

### Inspect content

None of these commands will alter the content of the UC in any way.

Command | |
--- | ---
`list.sh <update_center_id>` | List all plugins in UC with their versions.
`dependency-list.sh <update_center_id>` | List all plugins in UC listing dependent plugins. Note it does not check if dependencies are satisfied in that UC.
`client-fetch.sh <update_center_id> <local_dir>` | Download all plugins from UC into a local directory. This directory can be use as `$JENKINS_HOME/plugins` right away.
`diff.sh <src_update_center_id> <dst_update_center_id>` | Compare plugins and versions of 2 update centers.

### Manipulate content

These commands will modify the raw content, though not the generated content exposed through http server.

Command | |
--- | ---
`grab.sh <update_center_id> <artifact_id> [<version>]` | Grab community plugin identified by artifact id and version and place it into UC. Any old version will be removed. If version is omitted, latest community version will be used.
`remove.sh <update_center_id> <artifact_id...>` | Remove one or more plugins from an updatecenter.
`client-push.sh <update_center_id> <path_to_hpi> [<targe_file_name>]` | Place local hpi into update center. `targe_file_name` can be used optionally to use different basename. `grab.sh` is always preferred over direct pushing.
`promote.sh <src_update_center_id> <dst_update_center_id>` | Replace content of one UC by another. User will be prompted to confirm changes. This is useful to expose `testing` collection first and then *prmote* it to stable when ready.

### Publishing content

This commands manipulate generated content exposed through http server.

Command | |
--- | ---
`refre.sh <update_center_id>` | Expose update center data and metadata to the world. This effectively publishes the changes of the content.
